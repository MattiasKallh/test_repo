name: Create Draft Market Release from Tag

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  aggregate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      # --------------------------------------
      # Create Release + Aggregate Docs
      # --------------------------------------
      - name: Create draft release
        env:
          ORG: mattiasKallh
          TARGET_REPO: test_repo
          SOURCE_REPOS: test_repo_1
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          cd "$GITHUB_WORKSPACE"

          echo "Creating draft market release for tag: $TAG"

          REPOS=($SOURCE_REPOS)
          DOC_REPOS=()

          # --------------------------------------
          # Previous release cutoff
          # --------------------------------------
          PREV_DATE=$(gh release list \
            --repo "$ORG/$TARGET_REPO" \
            --json publishedAt,isDraft \
            --jq '
              [ .[]
                | select(.isDraft == false)
                | select(.publishedAt != null)
              ]
              | sort_by(.publishedAt)
              | last
              | .publishedAt
            ')

          if [ -z "$PREV_DATE" ] || [ "$PREV_DATE" = "null" ]; then
            PREV_DATE="1970-01-01T00:00:00Z"
          fi

          OUT=aggregated.md
          : > "$OUT"

          {
            echo "# Market Release $TAG"
            echo
            echo "## Highlights"
            echo "<!-- Edit before publishing -->"
            echo
          } >> "$OUT"

          # --------------------------------------
          # Process source repositories
          # --------------------------------------
          for REPO in "${REPOS[@]}"; do
            echo "Processing repository: $REPO"

            echo "## ${REPO}" >> "$OUT"
            echo >> "$OUT"

            TAGS=$(gh release list \
              --repo "$ORG/$REPO" \
              --json tagName,publishedAt \
              --jq ".[] | select(.publishedAt > \"$PREV_DATE\") | .tagName")

            if [ -z "$TAGS" ]; then
              echo "_No releases_" >> "$OUT"
              echo >> "$OUT"
              continue
            fi

            # --------------------------------------
            # Aggregate release notes
            # --------------------------------------
            for SUBTAG in $TAGS; do

              NAME=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json name,tagName \
                --jq '.name // .tagName')

              NOTES=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json body \
                --jq '.body')

              {
                echo "### ${NAME}"
                echo "${NOTES:-_No notes_}"
                echo
              } >> "$OUT"

            done

            # --------------------------------------
            # Documentation asset download
            # --------------------------------------
            LATEST_TAG=$(echo "$TAGS" | head -n 1)

            ASSET=$(gh release view "$LATEST_TAG" \
              --repo "$ORG/$REPO" \
              --json assets \
              --jq '.assets[] | select(.name | startswith("docs-")) | .name' \
              | head -n 1)

            if [ -z "$ASSET" ]; then
              echo "No docs asset found for $REPO"
              continue
            fi

            mkdir -p "./$REPO"

            gh release download "$LATEST_TAG" \
              --repo "$ORG/$REPO" \
              --pattern "$ASSET" \
              --dir "./$REPO"

            unzip -q "./$REPO/$ASSET" -d "./$REPO"
            rm "./$REPO/$ASSET"

            DOC_REPOS+=("$REPO")

            # --------------------------------------
            # Metadata injection using JSON manifest
            # --------------------------------------
            MANIFEST="./$REPO/docs.manifest.json"

            if [ ! -f "$MANIFEST" ]; then
              echo "Manifest not found for $REPO"
              continue
            fi

            echo "Injecting documentation metadata..."

            jq -c '
            def walk_nodes(parent):
              . as $node
              | {
                  file: $node.file,
                  title: $node.title,
                  parent: parent,
                  nav_order: ($node["nav-order"] // "")
                },
                (
                  $node.children[]?
                  | walk_nodes($node.title)
                );

            .navigation[] | walk_nodes("Documentation")
            ' "$MANIFEST" | while read NODE; do

              FILE=$(echo "$NODE" | jq -r '.file')
              TITLE=$(echo "$NODE" | jq -r '.title')
              PARENT=$(echo "$NODE" | jq -r '.parent')
              NAV_ORDER=$(echo "$NODE" | jq -r '.nav_order')

              TARGET_FILE="./$REPO/$FILE"

              if [ ! -f "$TARGET_FILE" ]; then
                echo "Warning: $TARGET_FILE not found"
                continue
              fi

              echo "Processing $TARGET_FILE"

              TMP=$(mktemp)

              # Remove existing frontmatter
              awk '
                BEGIN { in_frontmatter=0 }
                NR==1 && $0=="---" { in_frontmatter=1; next }
                in_frontmatter && $0=="---" { in_frontmatter=0; next }
                !in_frontmatter { print }
              ' "$TARGET_FILE" > "$TMP.content"

              {
                echo "---"
                echo "layout: default"
                echo "title: $TITLE"
                echo "parent: $PARENT"
                if [ -n "$NAV_ORDER" ]; then
                  echo "nav_order: $NAV_ORDER"
                fi
                echo "---"
                echo
                cat "$TMP.content"
              } > "$TMP"

              mv "$TMP" "$TARGET_FILE"
              rm "$TMP.content"

            done

          done

          # --------------------------------------
          # Create market release
          # --------------------------------------
          if gh release view "$TAG" --repo "$ORG/$TARGET_REPO" >/dev/null 2>&1; then
            echo "Release already exists"
          else
            gh release create "$TAG" \
              --repo "$ORG/$TARGET_REPO" \
              --title "$TAG" \
              --draft \
              --notes-file aggregated.md
          fi

          # --------------------------------------
          # Upload merged docs
          # --------------------------------------
          if [ ${#DOC_REPOS[@]} -gt 0 ]; then
            zip -r "market-docs-$TAG.zip" "${DOC_REPOS[@]}"

            gh release upload "$TAG" \
              "market-docs-$TAG.zip" \
              --repo "$ORG/$TARGET_REPO" \
              --clobber
          fi

          echo "Done."