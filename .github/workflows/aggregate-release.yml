name: Create Draft Market Release from Tag

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  aggregate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yq jq unzip

      - name: Create draft release with aggregated notes + docs
        env:
          ORG: mattiasKallh
          TARGET_REPO: test_repo
          SOURCE_REPOS: test_repo_1
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          echo "Creating draft market release for tag: $TAG"

          REPOS=($SOURCE_REPOS)
          DOC_REPOS=()

          # Get previous published (non-draft) release date
          PREV_DATE=$(gh release list \
            --repo "$ORG/$TARGET_REPO" \
            --json publishedAt,isDraft \
            --jq '
              [ .[]
                | select(.isDraft == false)
                | select(.publishedAt != null)
              ]
              | sort_by(.publishedAt)
              | last
              | .publishedAt
            ')

          if [ -z "$PREV_DATE" ] || [ "$PREV_DATE" = "null" ]; then
            PREV_DATE="1970-01-01T00:00:00Z"
          fi

          OUT=aggregated.md
          : > "$OUT"

          {
            echo "# Market Release $TAG"
            echo
            echo "## Highlights"
            echo "<!-- Edit before publishing -->"
            echo
          } >> "$OUT"

          for REPO in "${REPOS[@]}"; do
            echo "Processing repository: $REPO"

            echo "## ${REPO}" >> "$OUT"
            echo >> "$OUT"

            TAGS=$(gh release list \
              --repo "$ORG/$REPO" \
              --json tagName,publishedAt \
              --jq ".[] | select(.publishedAt > \"$PREV_DATE\") | .tagName")

            if [ -z "$TAGS" ]; then
              echo "_No releases_" >> "$OUT"
              echo >> "$OUT"
              continue
            fi

            for SUBTAG in $TAGS; do
              NAME=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json name,tagName \
                --jq '.name // .tagName')

              NOTES=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json body \
                --jq '.body')

              {
                echo "### ${NAME}"
                echo "${NOTES:-_No notes_}"
                echo
              } >> "$OUT"
            done

            # ---- DOC DOWNLOAD ----
            LATEST_TAG=$(echo "$TAGS" | head -n 1)

            ASSET=$(gh release view "$LATEST_TAG" \
              --repo "$ORG/$REPO" \
              --json assets \
              --jq '.assets[] | select(.name | startswith("docs-")) | .name' \
              | head -n 1)

            if [ -n "$ASSET" ]; then
              mkdir -p "./$REPO"

              gh release download "$LATEST_TAG" \
                --repo "$ORG/$REPO" \
                --pattern "$ASSET" \
                --dir "./$REPO"

              unzip -q "./$REPO/$ASSET" -d "./$REPO"
              rm "./$REPO/$ASSET"

              MANIFEST="./$REPO/docs.manifest.yaml"

              if [ -f "$MANIFEST" ]; then
                echo "Injecting metadata using manifest..."

                yq -o=json '
                  def walk_nodes(parent):
                    .[] as $node |
                    (
                      {
                        file: $node.file,
                        title: $node.title,
                        parent: parent
                      }
                    ),
                    (
                      if $node.children then
                        $node.children | walk_nodes($node.title)
                      else
                        empty
                      end
                    );

                  .navigation | walk_nodes("Documentation")
                ' "$MANIFEST" | jq -c '.' | while read NODE; do

                  FILE=$(echo "$NODE" | jq -r '.file')
                  TITLE=$(echo "$NODE" | jq -r '.title')
                  PARENT=$(echo "$NODE" | jq -r '.parent')

                  TARGET_FILE="./$REPO/$FILE"

                  if [ -f "$TARGET_FILE" ]; then
                    echo "Processing $TARGET_FILE"

                    TMP=$(mktemp)

                    {
                      echo "---"
                      echo "layout: default"
                      echo "title: $TITLE"
                      echo "parent: $PARENT"
                      echo "---"
                      echo
                      cat "$TARGET_FILE"
                    } > "$TMP"

                    mv "$TMP" "$TARGET_FILE"
                  fi
                done
              fi

              DOC_REPOS+=("$REPO")
            fi
          done

          if gh release view "$TAG" --repo "$ORG/$TARGET_REPO" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
          else
            gh release create "$TAG" \
              --repo "$ORG/$TARGET_REPO" \
              --title "$TAG" \
              --draft \
              --notes-file aggregated.md
          fi

          if [ ${#DOC_REPOS[@]} -gt 0 ]; then
            zip -r market-docs-$TAG.zip "${DOC_REPOS[@]}"
            gh release upload "$TAG" \
              market-docs-$TAG.zip \
              --repo "$ORG/$TARGET_REPO" \
              --clobber
          fi

          echo "Done."