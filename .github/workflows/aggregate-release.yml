name: Create Draft Market Release from Tag

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  aggregate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create draft release with aggregated notes + docs
        env:
          ORG: mattiasKallh
          TARGET_REPO: test_repo
          SOURCE_REPOS: test_repo_1
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -e

          echo "Creating draft market release for tag: $TAG"

          REPOS=($SOURCE_REPOS)

          PREV_DATE=$(gh release list \
            --repo "$ORG/$TARGET_REPO" \
            --json publishedAt,isDraft \
            --jq '
              [ .[]
                | select(.isDraft == false)
                | select(.publishedAt != null)
              ]
              | sort_by(.publishedAt)
              | last
              | .publishedAt
            ')

          if [ -z "$PREV_DATE" ] || [ "$PREV_DATE" = "null" ]; then
            PREV_DATE="1970-01-01T00:00:00Z"
          fi

          echo "Previous market release date: $PREV_DATE"

          OUT=aggregated.md
          : > "$OUT"

          # DOC_ROOT=market-docs
          # mkdir -p "$DOC_ROOT"

          {
            echo "# Market Release $TAG"
            echo
            echo "## Highlights"
            echo "<!-- Edit before publishing -->"
            echo
          } >> "$OUT"

          for REPO in "${REPOS[@]}"; do
            echo "Processing repository: $REPO"

            {
              echo "## ${REPO}"
              echo
            } >> "$OUT"

            TAGS=$(gh release list \
              --repo "$ORG/$REPO" \
              --json tagName,publishedAt \
              --jq ".[] | select(.publishedAt > \"$PREV_DATE\") | .tagName")

            if [ -z "$TAGS" ]; then
              echo "_No releases_" >> "$OUT"
              echo >> "$OUT"
              continue
            fi

            for SUBTAG in $TAGS; do
              echo "Handling $REPO $SUBTAG"
              NAME=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json name \
                --jq '.name // .tagName')

              NOTES=$(gh release view "$SUBTAG" \
                --repo "$ORG/$REPO" \
                --json body \
                --jq '.body')
              {
                echo "### ${NAME}"
                echo "${NOTES:-_No notes_}"
                echo
              } >> "$OUT"
            done

            # ---- DOC DOWNLOAD ----
            LATEST_TAG=$(echo "$TAGS" | head -n 1)
            echo "Latest tag for docs: $LATEST_TAG"

            ASSET=$(gh release view "$LATEST_TAG" \
              --repo "$ORG/$REPO" \
              --json assets \
              --jq '.assets[] | select(.name | startswith("docs-")) | .name' \
              | head -n 1)

            if [ -n "$ASSET" ]; then
              echo "Downloading docs asset $ASSET"

              mkdir -p "$DOC_ROOT/$REPO"

              # gh release download "$LATEST_TAG" \
              #   --repo "$ORG/$REPO" \
              #   --pattern "$ASSET" \
              #   --dir "$DOC_ROOT/$REPO"

              # unzip -q "$DOC_ROOT/$REPO/$ASSET" \
              #   -d "$DOC_ROOT/$REPO"

              # rm "$DOC_ROOT/$REPO/$ASSET"

              mkdir -p "$REPO"
              gh release download "$LATEST_TAG" \
                --repo "$ORG/$REPO" \
                --pattern "$ASSET" \
                --dir "$REPO"
              unzip -q "$REPO/$ASSET" \
                -d "$REPO"
              rm "$REPO/$ASSET"

            else
              echo "No docs asset found for $REPO"
            fi
            # ---- END DOC DOWNLOAD ----
          done

          echo "Creating draft release..."
          gh release create "$TAG" \
            --repo "$ORG/$TARGET_REPO" \
            --title "$TAG" \
            --draft \
            --notes-file aggregated.md

          echo "Zipping merged docs..."
          # zip -r market-docs-$TAG.zip "$DOC_ROOT"
          zip -r market-docs-$TAG.zip "${REPOS[@]}"

          echo "Uploading docs to draft release..."
          gh release upload "$TAG" \
            market-docs-$TAG.zip \
            --repo "$ORG/$TARGET_REPO"
